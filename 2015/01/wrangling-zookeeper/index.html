<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>Wrangling Zookeeper</title>
		<meta name="description" content="">
		<meta name="author" content="">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<link href='//fonts.googleapis.com/css?family=Raleway:400,300,600' rel='stylesheet' type='text/css'>
		<link rel="stylesheet" href="http://esell.github.io//css/normalize.css">
		<link rel="stylesheet" href="http://esell.github.io//css/skeleton.css">
		<link rel="stylesheet" href="http://esell.github.io//css/custom.css">
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
	</head>
	<body>
		<div class="container" style="background-color:#FFFFFF; border-bottom: 0px solid #eee;">
			<div class="row">
				<div class="seven columns">
					<a href="http://esell.github.io/" style="text-decoration: none; color: #333;"><span style="font-size: 36px; ">es<b>HeavyIndustries</b></span></a>
					<span style="font-size: 14px;">|<i>life, hobbies, work</i></span>
				</div>
				<div class="five columns">
					<div class="navbar-spacer"></div>
					<ul class="navbar-list" style="float:right">
						<li class="navbar-item"><a class="navbar-link" href="http://esell.github.io//series">projects</a></li>
						<li class="navbar-item"><a class="navbar-link" href="http://github.com/esell" target="#">code</a></li>
						<li class="navbar-item"><a class="navbar-link" href="mailto:esell@esheavyindustries.com">contact</a></li>
					</ul>
				</div>
			</div>
		</div>
		<div class="container">
			
			<div class="row">
				<div class="twelve columns" >
					<img class="u-max-full-width" src="http://esell.github.io//img/City-Under-Heat.jpg">
				</div>
			</div>
			



	<div class="row">
    	<div class="eight columns">
    		<a class="post-title-link" href="http://esell.github.io/2015/01/wrangling-zookeeper/">Wrangling Zookeeper</a>
    	</div>
    	
    </div>
	<span class="post-postedby">posted by esells on Jan 31, 2015</span>
	<div class="row">
		<div class="twelve columns">
			

<h5 id="spof:12b272660e693d03fef595b262170b60">SPOF</h5>

<p>SPOF = Single Point of Failure and we had one. It wasn&rsquo;t a traditional failure point like having a critical service running on a single server or something, it was the fact that we had no way to auto-scale, or at least automate spinning up, one of our key components: <a href="http://zookeeper.apache.org/">Apache Zookeeper</a></p>

<p><center>
<figure>
  <img src="/pics/zookeeper_small.gif" alt="zookeeper">
  <figcaption><b>smug bastard</b></figcaption>
</figure>
</center></p>

<p>As we had been drawing up the architecture for our new environment one of the requirements is everything must auto-scale or be push button. Since we will be working in AWS, the architecture has been designed to handle failures across the board. Having something that can&rsquo;t self heal or be re-provisioned without human intervention is dumb and would break our entire goal. There have been too many times where I&rsquo;ve heard &ldquo;So everything is automated&hellip; except this one part that fails all the time and we have to pay a team to monitor 24 hours a day. Oh and by the way that part that fails all the time is key to everything else working&rdquo;. Unfortunately Zookeeper is a bit old in it&rsquo;s ways and still requires a few areas of manual configuration and taking it out of our stack was not an option so what options did we have?</p>

<ol>
<li>Accept that we couldn&rsquo;t automate this part and that despite our grand idea of what could be we would just build the same hodgepodge of shit everyone else had.</li>
<li>Have a go with <a href="https://github.com/Netflix/exhibitor">Exhibitor</a>. Netflix built it so it&rsquo;s gotta be good right?</li>
<li>Build our own solution</li>
<li>Watch cat videos on youtube</li>
</ol>

<p>A combination of options 3 and 4 is what we ended going with (actually option 4, option 4 some more and then option 3. That led to some more of option 4). Why not option 2? While I&rsquo;m sure Exhibitor is a fantastic app, it just didn&rsquo;t feel right to us. The ideal way to use Exhibitor is with S3 which means we are relying on an AWS service. Our goal is to handle failures across the board so if we have a Zookeeper EC2 instance fail and a regional S3 failure we&rsquo;re fucked. We could probably build around that but it just adds another stack of shit to keep track of. Additionally with Exhibitor all of the Zookeeper management is now done through Exhibitor. This could be a good thing I guess but we didn&rsquo;t want yet another management tool being thrown into the mix.</p>

<p>Ok, enough gum flapping, here is how we solved the question of the century: how do you automate scaling Zookeeper?</p>

<p>Enter <a href="https://github.com/coreos/etcd">etcd</a> and <a href="https://github.com/kelseyhightower/confd">confd</a> (plus some custom <a href="http://golang.org">Go</a>)!</p>

<p><center>
<figure>
  <img src="/pics/jackpot.jpg" alt="jackpot">
  <figcaption><b>blammo!</b></figcaption>
</figure>
</center></p>

<p>We had already been using etcd for service discovery and minor random things we probably shouldn&rsquo;t be using it for so it was already part of our stack. Additionally our etcd groupings had already been built so they fit our requirement of being able to handle catastrophic failure. Confd had been on the radar for another portion of our architecture so we were familiar with it and thought we&rsquo;d toss it in the mix and see what happens. What happened was pure magic! The ability to add and remove Zookeeper instances without any human configuration and no additional AWS services to lean on. I guess it wasn&rsquo;t pure magic but it was pretty cool.</p>

<p>So how does this whole thing work? I&rsquo;m glad you asked:</p>

<ol>
<li>First we wrote a startup wrapper in Go for Zookeeper. At a high level what this wrapper does is control the &ldquo;myid&rdquo; file for the Zookeeper instance. There are various checks in there to make sure that one instance only gets one, previously unused ID. This information is published to etcd. On first start there is no cluster config so this new instance has an id but isn&rsquo;t actually joined to anything.</li>
<li>After we had figured out how to publish the information for everyone, we wrote up a quick confd template that builds out the &ldquo;zoo.cfg&rdquo; cluster details. This is the lame part because the number associated with the entry must match the &ldquo;myid&rdquo; of that host. So when you see &ldquo;server.2=zoo2:2888:3888&rdquo; in the config file, zoo2 better have an id of 2 or else shit might go down (literally). Once the config has been populated confd restarts Zookeeper. Confd is always checking in with etcd and updating the &ldquo;zoo.cfg&rdquo; file as needed.</li>
<li>We have another tiny Go app that when it has free time, checks the entries in etcd to make sure they are accurate and removes any dead hosts.</li>
</ol>

<p>So yeah, that&rsquo;s about it, nothing earth shattering by any means but a possible solution for some of you who are looking to do the same thing and for whatever reason are not interested in Exhibitor.</p>

		</div>
	</div>
	
	<div class="row">
        <div class="twelve columns">
            &nbsp;
        </div>
    </div>

    <div id="footer" class="row">
    	<div class="twelve columns">
			<center>
			<span style="font-size: small;">
				[ theme created by <a href="http://github.com/esell" style="text-decoration: none;" target="#">esell</a> ]
			</span>
			</center>
		</div>
    </div>
</div>

</body>
</html>


